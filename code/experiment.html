<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>

<style>

body {
    font-family: Arial, Helvetica;
    font-size: 14pt;
}

img {
    max-width: 100%;
    max-height: 100%;
}

p {
    margin: 0 auto;
    padding: 0;
}

.trialDiv {
    /* border: 2px solid gray; */
    padding: 0px;
    width: 650px;
    height: 650px;
    margin: 0 auto;
    display: none;
}

.imgDiv {
    /* img size is 1425:2175 (57:87) */
    width: 399px;
    height: 609px;
    padding: 0px;
    margin: 0 auto;
}

#instructions {
    width: 400;
    margin: 0 auto;
    text-align: center;
    margin-top: 100px;
}

.startButton {
    width: 200px;
    text-align: center;
    color: black;
    background-color: white;
    border: 2px solid #4CAF50;
    border-radius: 8px;
    padding: 4px;
    cursor:pointer;
    margin: 0 auto;
    margin-top: 6px;
}

.startButton:hover {
    background-color: #4CAF50;
    color: white;
}

.continueButton {
    width: 150px;
    text-align: center;
    color: black;
    background-color: white;
    border: 2px solid #008CBA;
    border-radius: 8px;
    padding: 0px;
    cursor: pointer;
    margin-top: -15px;
    margin-left: 600px;
}

.continueButton:hover {
    background-color: #008CBA;
    color: white;
}

.dot {
  height: 10px;
  width: 10px;
  background-color: red;
  border-radius: 50%;
  display: inline-block;
  position: absolute;
}

#submitButton {
    display: none;
}

</style>


<div id="instructions">
    <p> For each incomplete triangle, please move the dot to the missing corner location.
        <div id="startPracticeButton" class="startButton">Start Practice</div>
    </p>
</div>

<div id="pracTrial" class="trialDiv">
    <p> Move dot to the top corner location (marked in light blue). </p>
    <p style="color:red;"> You can only click once! </p>
    <div id="pracImage" class="imgDiv">
        <span id="pracDot" name="pracDot" class="dot"></span>
        <img id="pracImageSrc" src="http://web.stanford.edu/~liyuxuan/mturk/practice.png">
    </div>
    <div id="startExperimentButton" class="startButton" style="margin-left:600px; margin-top:-50;">Finish Practice and Start Experiment</div>
    <input type="hidden" name="pracX" id="pracX">
    <input type="hidden" name="pracY" id="pracY">
    <input type="hidden" name="pracRT" id="pracRT">
</div>

<div id="trial" class="trialDiv">
    <p> Move dot to the top corner location. </p>
    <div id="taskImage" class="imgDiv">
        <span id="taskDot" name="taskDot" class="dot"></span>
        <img id="taskImageSrc"  src="http://web.stanford.edu/~liyuxuan/mturk/practice.png">
    </div>
    <div id="continueButton" class="continueButton">Continue</div>
    <input type="hidden" name="taskX" id="taskX">
    <input type="hidden" name="taskY" id="taskY">
    <input type="hidden" name="taskRT" id="taskRT">
    <input type="hidden" name="trialIndex" id="trialIndex">
    <input type="hidden" name="trialImg" id="trialImg">
</div>

<script>

var verbose = false; //for testing purposes, logs things to the console
var isPractice;
var imgRoot = 'http://web.stanford.edu/~liyuxuan/mturk/';

// generate random trial sequence
var repeat = 1; // each image is shown 10 times, may be changed for testing purposes
var allImgs = Array(repeat).fill(0).concat(Array(repeat).fill(1),
                                         Array(repeat).fill(2),
                                         Array(repeat).fill(3),
                                         Array(repeat).fill(4),
                                         Array(repeat).fill(5),
                                         Array(repeat).fill(6),
                                         Array(repeat).fill(7),
                                         Array(repeat).fill(8),
                                         Array(repeat).fill(9),
                                         Array(repeat).fill(10),
                                         Array(repeat).fill(11),
                                         Array(repeat).fill(12),
                                         Array(repeat).fill(13),
                                         Array(repeat).fill(14))
var shuffledImages = shuffle(allImgs);
var trialIndex;
var nTrials = 15 * repeat;
var startTrialTime;
var group = (Math.random()<0.5)? 1 : 2 // may change to hard-coded 1 and 2
if (verbose) {
    console.log("group="+group);
    console.log("image sequence:", shuffledImages)
}

function moveDot(e){
    if (isPractice){
        $('#pracDot').css({
            left:  e.pageX-5,
            top:  e.pageY-5
        });
    }
    else {
        $('#taskDot').css({
            left:  e.pageX-5,
            top:  e.pageY-5
        });
    }
}

function dropDot() {
    var curTime = new Date();
    var trialRT = curTime - startTrialTime;
    // console.log(trialRT);

    // record data
    // account for the width/height (10px) of the dot, 
    // and record the x-y coordinates of the dot as the center of the dot
    // relative to the image boundaries (x-axis starts from left, y-axis starts from top)
    // note: the starting position of the dot it (5,5) relative to image because the radius of the dot is 5px
    // note: image dimension is 500px by 500px
    var x, y;
    if (isPractice) {
        x = ($('#pracDot').position().left+$('#pracDot').width()/2) - $('#pracImageSrc').position().left;
        y = ($('#pracDot').position().top+$('#pracDot').height()/2) - $('#pracImageSrc').position().top;
        $('#pracX').val(x);
        $('#pracY').val(y);
        $('#pracRT').val(trialRT);
        if (verbose) {
            console.log('pracX', $('#pracX').val());
            console.log('pracY', $('#pracY').val());
            console.log('pracRT', $('#pracRT').val());
        }
    }
    else {
        x = ($('#taskDot').position().left+$('#taskDot').width()/2) - $('#taskImageSrc').position().left;
        y = ($('#taskDot').position().top+$('#taskDot').height()/2) - $('#taskImageSrc').position().top;
        $('#taskX').val($('#taskX').val()+','+x);
        $('#taskY').val($('#taskY').val()+','+y);
        $('#taskRT').val($('#taskRT').val()+','+trialRT);
        if (verbose) {
            console.log('taskX', $('#taskX').val());
            console.log('taskY', $('#taskY').val());
            console.log('taskRT', $('#taskRT').val());
        }
    }
    $(document).unbind();
    if (isPractice) {
        $("#startExperimentButton").show();
    }
    else {
        $("#continueButton").show();
    }
}

function practiceTrial() {
    startTrialTime = new Date();
    isPractice = true;
    $('#instructions').hide();
    $('#pracTrial').show();
    $("#startExperimentButton").hide();
    $(document).bind('mousemove', moveDot);
}

function showTrial(whichImage) {
    var filename = imgRoot+'group'+group+'_'+whichImage+'.png';
    $('#taskImageSrc').attr('src', filename);
    $('#trial').show();
    $('#continueButton').hide();
    $(document).bind('mousemove', moveDot);
}

function showFirstTrial() {
    isPractice = false;
    $('#pracTrial').hide();
    trialIndex = 0;
    startTrialTime = new Date();
    $('#trialIndex').val($('#trialIndex')+','+trialIndex);
    $('#trialImg').val($('#trialImg')+','+shuffledImages[trialIndex]);
    if (verbose) {
        // console.log('tiral index: ', trialIndex);
        // console.log('tiral img: ', shuffledImages[trialIndex]);
    }
    showTrial(shuffledImages[trialIndex]);
}

function trialIsOver() {
    $("#trial").hide();
    trialIndex++;
    if (trialIndex >= nTrials) {
        $('#submitButton').show();
    } else {
        $('#trialIndex').val($('#trialIndex')+','+trialIndex);
        $('#trialImg').val($('#trialImg')+','+shuffledImages[trialIndex]);
        if (verbose) {
            // console.log('tiral index: ', trialIndex);
            // console.log('tiral img: ', shuffledImages[trialIndex]);
        }
        showTrial(shuffledImages[trialIndex]);
        startTrialTime = new Date();
    }
}

/* Fisher-Yates shuffle */
function shuffle(o){
    for(var j, x, i = o.length; i; j = Math.floor(Math.random() * i), x = o[--i], o[i] = o[j], o[j] = x);
    return o;
}

/* experiment flow */
$('#startPracticeButton').click(practiceTrial);
$('#startExperimentButton').click(showFirstTrial);
$('#continueButton').click(trialIsOver);
$('#pracDot').click(dropDot);
$('#taskDot').click(dropDot);

</script>

<!-- do not put this on Turk -->
<input type="submit" id="submitButton">